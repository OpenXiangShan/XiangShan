# This file describes the GitHub Actions workflow for continuous integration of XS Core.
name: EMU Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  generate-verilog:
    runs-on: self-hosted
    continue-on-error: false
    name: Generate Verilog
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Check Wiring
        run:
          bash .github/workflows/check-usage.sh "BoringUtils" $GITHUB_WORKSPACE
      - name: generate verilog file
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --generate --dual-core
  emu-basics:
    runs-on: self-hosted
    continue-on-error: false
    name: EMU - Basics
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: set env
        run:
          echo "PERF_HOME=/bigdata/xs-perf/${GITHUB_RUN_ID}_${GITHUB_SHA:0:5}" >> $GITHUB_ENV
      - name: Build EMU
        run: |
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --build \
            --nemu /home/ci-runner/NEMU                          \
            --disable-log --threads 8
      - name: Basic Test - cputest
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 8 --am /home/ci-runner/xsenv/nexus-am --ci cputest 2> /dev/zero
      - name: Basic Test - riscv-tests
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 8 --rvtest /home/ci-runner/xsenv/riscv-tests --ci riscv-tests 2> /dev/zero
      - name: Simple Test - microbench
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 8 --numa --am /home/ci-runner/xsenv/nexus-am --ci microbench 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-microbench.log
      - name: Simple Test - CoreMark
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 8 --numa --am /home/ci-runner/xsenv/nexus-am --ci coremark 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-coremark.log
      - name: System Test - Linux
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 8 --numa --ci linux-hello 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-linux.log
      - name: Floating-point Test - povray
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 8 --numa --max-instr 5000000 --ci povray 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-povray.log
  emu-performance:
    runs-on: self-hosted
    continue-on-error: false
    name: EMU - Performance
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: set env
        run:
          echo "PERF_HOME=/bigdata/xs-perf/${GITHUB_RUN_ID}_${GITHUB_SHA:0:5}" >> $GITHUB_ENV
      - name: Build EMU
        run: |
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --build \
            --nemu /home/ci-runner/NEMU                          \
            --dramsim3 /home/ci-runner/xsenv/DRAMsim3            \
            --disable-log --with-dramsim3 --threads 16
      - name: SPEC06 Test - mcf
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci mcf 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-mcf.log
      - name: SPEC06 Test - xalancbmk
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci xalancbmk 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-xalancbmk.log
      - name: SPEC06 Test - gcc
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci gcc 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-gcc.log
      - name: SPEC06 Test - namd
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci namd 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-namd.log
      - name: SPEC06 Test - milc
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci milc 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-milc.log
      - name: SPEC06 Test - lbm
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci lbm 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-lbm.log
      - name: SPEC06 Test - gromacs
        run:
          python3 $GITHUB_WORKSPACE/scripts/xiangshan.py --threads 16 --max-instr 5000000 --numa --ci gromacs 2> perf.log
          cat perf.log | sort | tee $PERF_HOME/$(date +%s)-${GITHUB_SHA:0:5}-gromacs.log

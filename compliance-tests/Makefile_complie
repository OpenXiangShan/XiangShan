RISCV_DEVICE  ?= XiangShan
RISCV_ISA  ?= rv64i

act_dir := .
tests_dir := $(act_dir)/riscv-test-suite/$(RISCV_ISA)/src
references_dir := $(act_dir)/riscv-test-suite/$(RISCV_ISA)/references
work_dir := $(act_dir)/work/$(RISCV_ISA)

RISCV_PREFIX   ?= riscv64-linux-gnu-
RISCV_GCC      ?= $(RISCV_PREFIX)gcc
RISCV_GNU      ?= $(RISCV_PREFIX)gnu
RISCV_OBJCOPY  ?= $(RISCV_PREFIX)objcopy
RISCV_ld       ?= $(RISCV_PREFIX)ld
RISCV_OBJDUMP  ?= $(RISCV_PREFIX)objdump

SRC=$(notdir $(wildcard $(tests_dir)/*.S))
OBJ_1=$(patsubst %.S,%.bin,$(addprefix $(work_dir)/bin_log/,$(SRC)))
OBJ_2=$(patsubst %.S,%.objdump,$(addprefix $(work_dir)/,$(SRC)))
OBJ_3=$(patsubst %.S,%.reference_output_n,$(addprefix $(work_dir)/,$(SRC)))

vpath %.S $(act_dir)

all:$(OBJ_1) $(OBJ_2) $(OBJ_3)
	@echo -e '/*\n$(RISCV_ISA)_Bin_files are ready!\n*/'
	@echo -e '/*\n$(RISCV_ISA)_Objdump_files are ready!\n*/'
	@echo -e '/*\n$(RISCV_ISA)_Reference_files are ready!\n*/'

$(work_dir)/%.reference_output_n:$(references_dir)/%.reference_output
ifeq ($(RISCV_ISA),rv32i)
	@sed -n '1,32p' $^ > $@
else
	@sed -n '1,50p' $^ > $@
endif

$(OBJ_2):%.objdump:%.elf
	@$(RISCV_OBJDUMP) -D $^ > $@

$(work_dir)/bin_log/%.bin:$(work_dir)/%.elf
	@mkdir -p $(work_dir)/bin_log/
	@$(RISCV_OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $^ $@


%.elf:%.o
	@$(RISCV_ld) -melf64lriscv \
		-L $(AM_HOME)/am/src/nemu/ldscript \
		-T $(AM_HOME)/am/src/nemu/isa/riscv/boot/loader64.ld \
		--gc-sections -o \
		$@ --start-group \
		$^ $(AM_HOME)/am/build/am-riscv64-noop.a \
		$(AM_HOME)/libs/klib/build/klib-riscv64-noop.a \
		--end-group
	
$(work_dir)/%.o:$(tests_dir)/%.S
	@mkdir -p $(work_dir)
	@$(RISCV_GCC) -fno-pic -march=rv64g \
		-mcmodel=medany -O0 -DMAINARGS=\"\" -MMD \
		-I/home/tjz/work/XiangShan/compliance-tests/riscv-test-env \
		-I/home/tjz/work/XiangShan/compliance-tests/riscv-test-env/p/ \
		-I/home/tjz/work/XiangShan/compliance-tests/riscv-target/Xiangshan \
		-T/home/tjz/work/XiangShan/compliance-tests/riscv-test-env/p/link.ld \
		-I$(AM_HOME)am/include/ \
		-I$(AM_HOME)/libs/klib/include/ \
		-I$(AM_HOME)/am/ -I$(AM_HOME)/am/include -c -o \
		$@ $^
	
.PRECIOUS: $(work_dir)/%.o


.PHONY:clean
clean:
	rm -r ./work/$(RISCV_ISA)/*.reference_output_n


                                                                                                                                                                                                                                                                                                                         		
